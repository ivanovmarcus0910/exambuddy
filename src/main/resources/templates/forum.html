<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning - H·ªçc Online</title>
  <link rel="stylesheet" th:href="@{/css/general.css}">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      color: black;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 3fr 1fr;
      width: 90%;
      max-width: 1200px;
      gap: 20px;
      margin-top: 20px;
    }
    .sidebar, .ranking, .main-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
    }
    .posts .post {
      background: #e8e8e8;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .post-images img {
      width: 100%;
      border-radius: 5px;
    }
    .post-images .image-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .post-images .image-container img {
      width: calc(50% - 5px);
    }
    .post-images .more-images {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }
    .hidden-images {
      display: none;
      flex-wrap: wrap;
      gap: 10px;
    }
    .hidden-images img {
      width: calc(50% - 5px);
    }
    .collapse-images {
      display: none;
      text-align: center;
      margin-top: 10px;
      padding: 5px;
      background-color: #f0f0f0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
    }

    .collapse-images:hover {
      background-color: #e0e0e0;
    }

    textarea {
      border: 2px solid #000;
      width: 100%;
      padding: 10px;
      resize: none;
    }
    .red-button {
      background-color: red;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
    }
    .like-button {
      cursor: pointer; /* Hi·ªÉn th·ªã con tr·ªè khi di chu·ªôt qua */
      font-size: 20px; /* K√≠ch th∆∞·ªõc bi·ªÉu t∆∞·ª£ng tim */
      color: black; /* M√†u m·∫∑c ƒë·ªãnh (n·∫øu c·∫ßn) */
    }

    .like-button.liked {
      color: red; /* M√†u ƒë·ªè khi ƒë∆∞·ª£c like */
    }

    .like-count {
      margin-left: 5px; /* Kho·∫£ng c√°ch gi·ªØa bi·ªÉu t∆∞·ª£ng tim v√† s·ªë l∆∞·ª£t th√≠ch */
      font-size: 16px; /* K√≠ch th∆∞·ªõc s·ªë l∆∞·ª£t th√≠ch */
    }

    .comment-image {
      max-width: 100px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
      max-height: 100px; /* Gi·ªõi h·∫°n chi·ªÅu cao t·ªëi ƒëa */
      cursor: pointer; /* Hi·ªÉn th·ªã con tr·ªè khi di chu·ªôt qua ·∫£nh */
      border-radius: 5px; /* Bo g√≥c ·∫£nh */
      margin: 5px 0; /* Th√™m kho·∫£ng c√°ch gi·ªØa c√°c ·∫£nh */
    }

    .comment {
      margin-bottom: 15px; /* Kho·∫£ng c√°ch gi·ªØa c√°c comment */
      padding: 10px; /* Kho·∫£ng c√°ch b√™n trong comment */
      background-color: #f9f9f9; /* M√†u n·ªÅn nh·∫π */
      border-radius: 5px; /* Bo g√≥c */
    }

    .comment-images {
      display: flex;
      gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c ·∫£nh */
      flex-wrap: wrap; /* Xu·ªëng d√≤ng n·∫øu c√≥ nhi·ªÅu ·∫£nh */
    }
    .hidden {
      display: none;
    }

    #lightbox {
      display: none; /* ·∫®n lightbox ban ƒë·∫ßu */
    }

    #lightbox.show {
      display: flex; /* Hi·ªÉn th·ªã lightbox khi c·∫ßn */
    }

    #lightbox-close {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      color: white;
      cursor: pointer;
    }

  </style>
</head>
<body>
<div th:insert="fragments/header :: header"></div>
<div class="container">
  <aside class="sidebar">
    <h2>Other Test</h2>
    <ul>
      <li>Test 1</li>
      <li>Test 2</li>
      <li>Test 3</li>
    </ul>
  </aside>
  <main class="main-content">
    <div th:if="${username}">
      <form action="/forum/create" method="post" enctype="multipart/form-data">
        <input type="hidden" name="username" th:value="${username}">
        <p>Username: <span th:text="${username}"></span></p>
        <textarea name="content" placeholder="H·ªèi g√¨ ƒë√≥ ..." required></textarea><br>
        <input type="file" name="images" multiple><br>
        <button type="submit" class="red-button">ƒêƒÉng b√†i</button>
      </form>
    </div>
    <p th:if="${username == null}">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i.</p>
    <div class="posts">
      <div class="post" th:each="post : ${posts}">
        <h3 th:text="${post.username}"></h3>
        <p th:text="${post.content}"></p>
        <div class="post-images">
          <div th:if="${#lists.size(post.imageUrls) == 1}">
            <img th:src="${post.imageUrls[0]}" alt="Post Image">
          </div>
          <div th:if="${#lists.size(post.imageUrls) > 1}" class="image-container">
            <img th:each="imageUrl, iterStat : ${post.imageUrls}"
                 th:if="${iterStat.index < 2}" th:src="${imageUrl}"
                 onclick="openImage(this)" alt="Post Image">
            <div th:if="${#lists.size(post.imageUrls) > 2}" class="more-images"
                 th:text="'+' + (${#lists.size(post.imageUrls)} - 2) + ' ·∫£nh n·ªØa'"
                 onclick="showAllImages(this)"></div>
            <div class="hidden-images" style="display: none;">
              <img th:each="imageUrl, iterStat : ${post.imageUrls}"
                   th:if="${iterStat.index >= 2}"
                   th:src="${imageUrl}" onclick="openImage(this)"
                   alt="Post Image">
            </div>
            <div class="collapse-images" style="display: none;" onclick="collapseImages(this)">
              Thu g·ªçn
            </div>
          </div>
        </div>
        <div class="post-actions">
          <span class="like-button" th:attr="data-post-id=${post.postId}"
                th:classappend="${post.liked} ? 'liked' : ''"
                onclick="toggleLike(this)">
            <span th:text="${post.liked ? '‚ù§Ô∏è' : 'ü§ç'}"></span>
          </span>
          <span class="like-count" th:text="${post.likeCount}">0</span>
          <span class="toggle-comments">üí¨</span>
          <span>üîÑ</span>
          <span>‚ö†Ô∏è</span>
        </div>
        <div class="post-comments hidden">
          <div class="comments-list">
            <div th:each="comment : ${post.comments}" class="comment">
              <p><strong th:text="${comment.username}"></strong>: <span th:text="${comment.content}"></span></p>
              <!-- Hi·ªÉn th·ªã ·∫£nh trong comment -->
              <div th:if="${comment.imageUrls != null and !comment.imageUrls.isEmpty()}">
                <div class="comment-images">
                  <img th:each="imageUrl : ${comment.imageUrls}"
                       th:src="${imageUrl}"
                       class="comment-image"
                       onclick="openImage(this)"
                       alt="Comment Image">
                </div>
              </div>
            </div>
          </div>
          <div class="create-comment">
            <form action="/forum/comment" method="post" enctype="multipart/form-data">
              <input type="hidden" name="postId" th:value="${post.postId}">
              <input type="hidden" name="username" th:value="${username}">
              <textarea name="content" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." rows="1"></textarea><br>
              <input type="file" name="commentImages" multiple><br>
              <button type="submit" class="red-button">B√¨nh lu·∫≠n</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  <aside class="ranking">
    <h2>Ranking</h2>
    <ul>
      <li>Username 1 - Score</li>
      <li>Username 2 - Score</li>
    </ul>
  </aside>
</div>

<script>
  document.querySelectorAll('.toggle-comments').forEach(button => {
    button.addEventListener('click', function () {
      const commentsSection = this.parentElement.nextElementSibling;
      commentsSection.classList.toggle('hidden');
    });
  });
  function showAllImages(element) {
    const hiddenImages = element.nextElementSibling;
    const collapseButton = hiddenImages.nextElementSibling;

    hiddenImages.style.display = "flex";
    collapseButton.style.display = "block";
    element.style.display = "none";
  }
  function collapseImages(element) {
    // T√¨m ph·∫ßn t·ª≠ ch·ª©a c√°c ·∫£nh ·∫©n
    const hiddenImages = element.previousElementSibling;
    // T√¨m ph·∫ßn "+x ·∫£nh"
    const moreImagesButton = hiddenImages.previousElementSibling;

    // ·∫®n c√°c ·∫£nh th·ª´a
    hiddenImages.style.display = "none";
    // ·∫®n n√∫t "Thu g·ªçn"
    element.style.display = "none";

    // Hi·ªÉn th·ªã l·∫°i ph·∫ßn "+x ·∫£nh"
    moreImagesButton.style.display = "flex";
  }

  function toggleLike(button) {
    const likeCountElement = button.nextElementSibling;
    const postId = button.getAttribute("data-post-id");
    const username = document.querySelector('input[name="username"]').value;
    let liked = button.classList.contains("liked");

    // C·∫≠p nh·∫≠t giao di·ªán tr∆∞·ªõc khi g·ª≠i request
    if (liked) {
      button.classList.remove("liked");
      button.textContent = "ü§ç";
    } else {
      button.classList.add("liked");
      button.textContent = "‚ù§Ô∏è";
    }

    // G·ª≠i request c·∫≠p nh·∫≠t tr·∫°ng th√°i like
    fetch("/forum/like", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `postId=${postId}&username=${username}&liked=${!liked}`
    })
            .then(response => response.json())
            .then(data => {
              // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t th√≠ch m√† kh√¥ng c·∫ßn reload trang
              if (data.likeCount !== undefined) {
                likeCountElement.textContent = data.likeCount;
              }
            })
            .catch(error => {
              console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£t th√≠ch:', error);
            });
  }

  function openImage(img) {
    // L·∫•y th·∫ª lightbox v√† ·∫£nh l·ªõn
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxClose = document.getElementById('lightbox-close');

    // G√°n ·∫£nh ngu·ªìn v√†o lightbox
    lightboxImage.src = img.src;

    // Hi·ªÉn th·ªã lightbox
    lightbox.classList.add('show');

    // ƒê√≥ng lightbox khi nh·∫•n n√∫t "X"
    lightboxClose.onclick = function () {
      lightbox.classList.remove('show');
    };

    // ƒê√≥ng lightbox khi nh·∫•n ra ngo√†i ·∫£nh
    lightbox.onclick = function (e) {
      if (e.target === lightbox) {
        lightbox.classList.remove('show');
      }
    };
  }
</script>
<div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
  <img id="lightbox-image" class="max-w-full max-h-full object-contain" alt="Enlarged Image">
  <button id="lightbox-close" class="absolute top-4 right-4 text-white text-3xl font-bold cursor-pointer">√ó</button>
</div>
</body>
</html>
