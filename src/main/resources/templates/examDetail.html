<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt ƒë·ªÅ thi</title>
    <link rel="icon" type="image/x-icon" href="https://res.cloudinary.com/dsuav027e/image/upload/v1740393796/favicon_llcueu.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link type="text/css" href="/css/feedback.css" rel="stylesheet">
    <script src="/js/feedback.js"></script>
</head>
<body class="bg-light">
<!-- Header -->
<div th:insert="~{fragments/header :: header}"></div>


<!-- Container -->
<div class="container py-5">
    <div th:if="${err}" class="alert alert-danger text-center" th:text="${err}"></div>

    <h2 class="text-center fw-bold mb-4" >Chi ti·∫øt ƒë·ªÅ thi</h2>

    <div th:if="${exam != null and exam.getStatus() == 'DISABLED'}" class="alert alert-danger text-center" role="alert">
        Xin l·ªói! B√†i thi ƒë√£ b·ªã x√≥a.
    </div>
    <div th:unless="${exam != null and exam.getStatus() == 'DISABLED'}">
    <div class="row">
        <!-- Exam Details -->
        <div class="col-md-8">
            <div class="card shadow-sm p-4">
                <h4 class="text-primary fw-bold text-center" th:text="${exam.examName}"></h4>
                <p><b>M√¥n h·ªçc:</b> <span th:text="${exam.subject}"></span></p>
                <p><b>L·ªõp:</b> <span th:text="${exam.grade}"></span></p>
                <p><b>Ng√†y ƒëƒÉng:</b> <span th:text="${exam.getFormattedDate()}"></span></p>
                <p><b>S·ªë c√¢u h·ªèi:</b> <span th:text="${questions.size()}"></span></p>
                <h5 class="mt-4">Danh s√°ch c√¢u h·ªèi:</h5>
                <ul class="list-group">
                    <li class="list-group-item" th:each="question, iterStat : ${questions}">
                        <p><b>C√¢u [[${iterStat.index + 1}]]:</b> <span th:text="${question.questionText}"></span></p>
                    </li>
                </ul>
                <div class="text-center mt-4" th:unless="${exam != null and exam.getStatus() == 'PENDING'}">
                    <form th:action="@{/exams/{id}/do(id=${exam.examID})}" method="get">
                        <button class="btn btn-primary">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                    </form>
                </div>
            </div>
        </div>


        <!-- Feedback Section -->
        <div class="col-md-4">
            <div class="card shadow-sm p-4">
                <h5 class="text-primary fw-bold">Feedback</h5>
                <button class="btn btn-outline-secondary btn-sm share-button" type="button" th:data-exam-id="${exam.examID}">
                    <i class="fas fa-share-alt"></i> Share
                </button>
                <!-- ƒê√°nh gi√° trung b√¨nh -->
                <div class="mb-3">
                    <h6 class="fw-bold">ƒê√°nh gi√° trung b√¨nh:</h6>
                    <div>
                        <span th:text="${T(java.lang.String).format('%.1f', ratingSummary.average)} + ' / 5'"></span>



                        <span class="text-muted"> (T·ª´ <span th:text="${ratingSummary.total}"></span> ph·∫£n h·ªìi)</span>

                    </div>

                    <!-- B·ªô l·ªçc theo sao -->
                    <div class="mt-2">
                        <label class="form-label fw-bold">L·ªçc theo sao:</label>
                        <select id="filter-star" class="form-select form-select-sm" onchange="filterFeedbacksByStar()">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="5">5 sao</option>
                            <option value="4">4 sao</option>
                            <option value="3">3 sao</option>
                            <option value="2">2 sao</option>
                            <option value="1">1 sao</option>
                        </select>
                    </div>
                </div>

                <!-- Feedback Form -->
                <div th:if="${isLoggedIn and not hasCommented and not isExamCreator}">
                    <form id="feedback-form" th:action="@{/exams/{examId}/feedback(examId=${exam.examID})}" method="post" class="mb-3">
                        <div class="mb-2">
                            <label for="content" class="form-label">N·ªôi dung ph·∫£n h·ªìi:</label>
                            <textarea id="content" name="content" class="form-control" placeholder="Nh·∫≠p ph·∫£n h·ªìi c·ªßa b·∫°n" required></textarea>
                        </div>
                        <div class="mb-2 star-rating">
                            <label class="form-label">ƒê√°nh gi√°:</label><br>
                            <i class="fa-solid fa-star" data-rate="1"></i>
                            <i class="fa-solid fa-star" data-rate="2"></i>
                            <i class="fa-solid fa-star" data-rate="3"></i>
                            <i class="fa-solid fa-star" data-rate="4"></i>
                            <i class="fa-solid fa-star" data-rate="5"></i>
                            <input type="hidden" id="rate" name="rate" value="0">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">G·ª≠i ph·∫£n h·ªìi</button>
                    </form>
                </div>
                <p th:if="${isLoggedIn and hasCommented and not isExamCreator}" class="text-muted">B·∫°n ƒë√£ g·ª≠i feedback. Ch·ªâ c√≥ th·ªÉ ch·ªânh s·ª≠a ho·∫∑c x√≥a.</p>
                <p th:if="${isExamCreator}" class="text-muted">B·∫°n l√† ng∆∞·ªùi t·∫°o ƒë·ªÅ, ch·ªâ c√≥ th·ªÉ tr·∫£ l·ªùi feedback.</p>
                <div th:unless="${isLoggedIn}">
                    <p>Vui l√≤ng <a href="/login">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ g·ª≠i ph·∫£n h·ªìi.</p>
                </div>


                <!-- Feedback List -->
                <div id="feedback-list" class="overflow-auto" style="max-height: 400px; padding-right: 10px; border-top: 1px solid #ccc; margin-top: 1rem;">

                <div th:each="feedback : ${feedbacks}" th:if="${!feedback.isReply}" class="feedback-item mb-3 border-bottom pb-2" th:id="'feedback-' + ${feedback.feedbackId}" th:data-exam-id="${exam.examID}">
                        <!-- Feedback Content -->
                        <div class="feedback-header d-flex align-items-center justify-content-between">
                            <div>
                                <img th:src="${feedback.avatarUrl}" alt="Avatar" width="30" class="rounded-circle me-2" th:unless="${feedback.avatarUrl == null}"/>
                                <strong th:text="${feedback.username}"></strong>
                            </div>
                            <div class="feedback-actions" th:if="${username == feedback.username}">
                                <span class="more-options" style="cursor: pointer; font-size: 1.2rem;">‚ãÆ</span>
                                <div class="action-menu" style="display: none; position: absolute; right: 10px; background: white; border: 1px solid #ddd; padding: 5px; border-radius: 3px;">
                                    <button class="btn btn-sm btn-warning edit-feedback" th:data-id="${feedback.feedbackId}">Update</button>
                                    <button class="btn btn-sm btn-danger delete-feedback" th:data-id="${feedback.feedbackId}">Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="feedback-content">
                            <p class="mt-1" th:text="${feedback.content}"></p>
                            <div class="star-display">
                               <span th:each="i : ${#numbers.sequence(1, 5)}">
                                   <i class="fa-star" th:classappend="${i <= feedback.rate} ? 'fas' : 'far'"></i>
                               </span>
                            </div>
                            <small class="text-muted" th:text="${feedback.timeAgo}"></small>
                        </div>


                        <!-- Reply Section -->
                        <div th:each="reply : ${feedbacks}" th:if="${reply.isReply and reply.parentFeedbackId == feedback.feedbackId}" class="reply-item ms-4 mt-2" th:id="'feedback-' + ${reply.feedbackId}" th:data-exam-id="${exam.examID}">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <img th:src="${reply.avatarUrl}" alt="Avatar" width="30" class="rounded-circle me-2" th:if="${reply.avatarUrl != null && reply.avatarUrl != ''}" />
                                    <img src="https://via.placeholder.com/30" alt="Avatar" width="30" class="rounded-circle me-2" th:if="${reply.avatarUrl == null || reply.avatarUrl == ''}" />
                                    <strong th:text="${reply.username}"></strong>
                                    <span class="ms-2" th:text="'(Ng∆∞·ªùi t·∫°o ƒë·ªÅ)'"></span>
                                </div>
                                <div class="feedback-actions" th:if="${isExamCreator and username == reply.username}">
                                    <span class="more-options" style="cursor: pointer; font-size: 1.2rem;">‚ãÆ</span>
                                    <div class="action-menu" style="display: none; position: absolute; right: 10px; background: white; border: 1px solid #ddd; padding: 5px; border-radius: 3px;">
                                        <button class="btn btn-sm btn-warning edit-feedback" th:data-id="${reply.feedbackId}">Update</button>
                                        <button class="btn btn-sm btn-danger delete-feedback" th:data-id="${reply.feedbackId}">Delete</button>
                                    </div>
                                </div>
                            </div>
                            <p th:text="${reply.content}"></p>
                            <small class="text-muted" th:text="${reply.timeAgo}"></small>
                            <form class="edit-feedback-inline" th:action="@{/exams/{id}/feedback/edit(id=${exam.examID})}" method="post" style="display: none;" th:id="'edit-form-' + ${reply.feedbackId}">
                                <input type="hidden" name="feedbackId" th:value="${reply.feedbackId}">
                                <div class="mb-2">
                                    <textarea name="content" class="form-control" th:text="${reply.content}" required></textarea>
                                </div>
                                <div class="mb-2 star-rating" th:unless="${reply.isReply}">
                                    <i class="fa-solid fa-star" data-rate="1"></i>
                                    <i class="fa-solid fa-star" data-rate="2"></i>
                                    <i class="fa-solid fa-star" data-rate="3"></i>
                                    <i class="fa-solid fa-star" data-rate="4"></i>
                                    <i class="fa-solid fa-star" data-rate="5"></i>
                                    <input type="hidden" name="rate" th:value="${reply.rate}" class="edit-rate-inline">
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-edit-inline">Cancel</button>
                            </form>
                        </div>




                        <!-- Reply Form (for exam creator) -->
                        <div th:if="${isExamCreator}">
                            <form th:action="@{/exams/{examId}/feedback/{feedbackId}/reply(examId=${exam.examID}, feedbackId=${feedback.feedbackId})}" method="post" class="ms-4 mt-2">
                                <textarea name="content" class="form-control" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n" required></textarea>
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Tr·∫£ l·ªùi</button>
                            </form>
                        </div>


                        <!-- Edit Feedback Form -->
                        <form class="edit-feedback-inline" th:action="@{/exams/{id}/feedback/edit(id=${exam.examID})}" method="post" style="display: none;" th:id="'edit-form-' + ${feedback.feedbackId}">
                            <input type="hidden" name="feedbackId" th:value="${feedback.feedbackId}">
                            <div class="mb-2">
                                <textarea name="content" class="form-control" th:text="${feedback.content}" required></textarea>
                            </div>
                            <div class="mb-2 star-rating" th:unless="${feedback.isReply}">
                                <i class="fa-solid fa-star" data-rate="1"></i>
                                <i class="fa-solid fa-star" data-rate="2"></i>
                                <i class="fa-solid fa-star" data-rate="3"></i>
                                <i class="fa-solid fa-star" data-rate="4"></i>
                                <i class="fa-solid fa-star" data-rate="5"></i>
                                <input type="hidden" name="rate" th:value="${feedback.rate}" class="edit-rate-inline">
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-secondary cancel-edit-inline">Cancel</button>
                        </form>
                    </div>
                    <div th:if="${feedbacks == null or #lists.isEmpty(feedbacks)}" class="text-muted">
                        Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o.
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>


<!-- Back to Exam List -->
<div class="mb-3 text-center">
    <a href="/search-by-filter" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch b√†i ki·ªÉm tra
    </a>
</div>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<!-- Modal Th√¥ng b√°o -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">Th√¥ng b√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="feedbackModalBody">
                <!-- N·ªôi dung th√¥ng b√°o -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal X√°c nh·∫≠n x√≥a -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">X√°c nh·∫≠n x√≥a</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph·∫£n h·ªìi n√†y kh√¥ng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>


</body>
<script>
    document.addEventListener('click', function (event) {
        const shareButton = event.target.closest('.share-button');
        if (!shareButton) return;


        const examId = shareButton.getAttribute('data-exam-id');
        const examUrl = `${window.location.origin}/exams/${examId}`;


        navigator.clipboard.writeText(examUrl).then(() => {
            console.log('üîó Link ƒë√£ sao ch√©p:', examUrl);
        }).catch(error => console.error('L·ªói sao ch√©p:', error));


        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: examUrl
            }).then(() => {
                alert('üîó Link ƒë·ªÅ thi ƒë√£ ƒë∆∞·ª£c sao ch√©p!');
            }).catch(error => console.error('L·ªói chia s·∫ª:', error));
        } else {
            alert('üîó Link ƒë·ªÅ thi ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o clipboard!');
        }
    });




        function filterFeedbacksByStar() {
        const selectedStar = document.getElementById("filter-star").value;
        const allFeedbacks = document.querySelectorAll(".feedback-item");

        allFeedbacks.forEach(item => {
        const stars = item.querySelectorAll(".star-display .fas").length;
        if (selectedStar === "all" || parseInt(selectedStar) === stars) {
        item.style.display = "block";
    } else {
        item.style.display = "none";
    }
    });
    }


</script>


</html>

