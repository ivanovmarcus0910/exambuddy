<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning - Học Online</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="icon" type="image/x-icon"
          href="https://res.cloudinary.com/dsuav027e/image/upload/v1740393796/favicon_llcueu.ico">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<style>
    body {
        background-color: #f5f7f9;
    }
    .toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 5px;
        padding: 10px;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.5s, bottom 0.5s;
    }

    .btn-custom {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 24px; /* Tăng kích thước */
        border-radius: 30px; /* Bo tròn hơn */
        font-size: 16px;
        font-weight: bold;
        text-decoration: none;
        transition: all 0.3s ease-in-out;
    }

    .btn-custom i {
        margin-right: 8px; /* Tạo khoảng cách giữa icon và text */
    }

    .btn-view {
        background: linear-gradient(to right, #007bff, #00c6ff);
        color: white;
        border: none;
    }

    .btn-view:hover {
        background: linear-gradient(to right, #0056b3, #0094cc);
    }

    .btn-do {
        background: linear-gradient(to right, #f32424, #ff5733);
        color: white;
        border: none;
    }

    .btn-do:hover {
        background: linear-gradient(to right, #c71c1c, #cc4422);
    }

    .rank-section {
        background: linear-gradient(to bottom, #ffffff, #f8f9fa); /* Gradient nhẹ */
        border-radius: 15px;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: transform 0.3s ease-in-out;
    }

    .rank-section:hover {
        transform: translateY(-5px); /* Hiệu ứng nâng lên khi hover */
    }

    .rank-section h4 {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .list-group {
        border-radius: 10px;
        overflow: hidden;
    }

    .list-group-item {
        border: none;
        padding: 12px 15px;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease-in-out;
    }

    .list-group-item:nth-child(odd) {
        background: #f1f3f5;
    }

    .list-group-item:nth-child(even) {
        background: #e9ecef;
    }

    .list-group-item:hover {
        background: #d4edda; /* Hiệu ứng xanh nhạt khi hover */
    }
    .rank-section {
        position: sticky;
        top: 20px; /* Cách lề trên 20px khi cuộn */
        z-index: 1000; /* Đảm bảo không bị che */
    }
    .toast.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
    }

    .title-button {
        display: inline-block;
        background: linear-gradient(to right, #007bff, #00c6ff); /* Chuyển từ xanh dương đậm sang xanh dương nhạt */
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 20px;
        border: none;
        cursor: pointer;
    }


    .exam-card {
        border: 1px; /* Viền dày 3px, màu đậm hơn */
        border-radius: 20px;
        transition: all 0.3s ease;
        background: white;
    }

    .exam-card:hover {
        box-shadow: 4px 8px 16px rgba(0, 0, 0, 0.2);
        transform: translateY(-5px);
        border-color: #000; /* Làm viền đậm hơn khi hover */
    }


</style>
<body>
<div th:insert="~{fragments/header :: header}"></div>

<div id="toast" class="toast"></div>
<main>
    <section class="hero-section py-5">
        <div class="container-fluid">
            <div class="row align-items-center bg-purple text-white rounded shadow-lg p-5"
                 style="background-image: url('https://res.cloudinary.com/dsuav027e/image/upload/v1740965767/nen_shiedq.jpg'); background-size: cover; background-position: center;">
                <!-- Nội dung chữ -->
                <div class="col-12 col-md-8">
                    <div class="text-box">
                        <h1 class="fw-bold text-uppercase" style="font-size: 70px;">Phát triển & nâng cao <br> kỹ năng của bạn</h1>
                        <button class="btn btn-light btn-lg text-purple fw-bold" style="color: #6f42c1;">Khám phá
                        </button>
                    </div>
                </div>

                <!-- Hình ảnh -->
                <div class="col-12 col-md-4 text-center">
                    <img src="/img/studentVR.png" alt="Học viên VR" class="img-fluid rounded">
                </div>
            </div>
        </div>
    </section>



    <!-- Thanh tìm kiếm -->`
    <p class="search-text col-md-12" style="display: flex; justify-content: center; font-size: 40px;">Tìm kiếm đề thi
        mong muốn của bạn</p>
    <div class="card shadow-lg p-4 bg-white rounded mx-auto" style="max-width: 900px; margin-bottom: 50px;">
        <h4 class="text-center text-success mb-3">Tìm kiếm đề thi</h4>
        <form action="/search-by-filter" method="get" class="d-flex flex-wrap gap-2 justify-content-between">
            <select name="grade" class="form-select flex-grow-1">
                <option value="">Chọn khối lớp</option>
                <option value="10">Lớp 10</option>
                <option value="11">Lớp 11</option>
                <option value="12">Lớp 12</option>
            </select>

            <select name="subject" class="form-select flex-grow-1">
                <option value="">Chọn môn học</option>
                <option value="Toán">Toán</option>
                <option value="Văn">Văn</option>
                <option value="Anh">Anh</option>
                <option value="Lý">Lý</option>
                <option value="Hóa">Hóa</option>
                <option value="Sinh">Sinh</option>
                <option value="Sử">Sử</option>
                <option value="Địa">Địa</option>
                <option value="GDCD">GDCD</option>
            </select>

            <select name="examType" class="form-select flex-grow-1">
                <option value="">Chọn loại đề</option>
                <option value="Đề kiểm tra">Đề kiểm tra</option>
                <option value="Đề luyện tập">Đề luyện tập</option>
                <option value="Đề THPT QUỐC GIA">Đề THPT QUỐC GIA</option>
            </select>

            <select name="city" id="city" class="form-select flex-grow-1">
                <option value="">Chọn thành phố</option>
            </select>

            <div class="d-flex w-100 mt-2 gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">Tìm kiếm</button>
                <a href="/search-by-filter" class="btn btn-secondary w-20">Xem tất cả</a>
            </div>
        </form>
    </div>


    <script>
        const cities = ["Hà Nội", "Hồ Chí Minh", "Đà Nẵng", "Hải Phòng", "Cần Thơ", "An Giang", "Bà Rịa - Vũng Tàu",
            "Bắc Giang", "Bắc Kạn", "Bạc Liêu", "Bắc Ninh", "Bến Tre", "Bình Định", "Bình Dương", "Bình Phước", "Bình Thuận", "Cà Mau",
            "Cao Bằng", "Đắk Lắk", "Đắk Nông", "Điện Biên", "Đồng Nai", "Đồng Tháp", "Gia Lai", "Hà Giang", "Hà Nam", "Hà Tĩnh", "Hải Dương",
            "Hậu Giang", "Hòa Bình", "Hưng Yên", "Khánh Hòa", "Kiên Giang", "Kon Tum", "Lai Châu", "Lâm Đồng", "Lạng Sơn", "Lào Cai", "Long An",
            "Nam Định", "Nghệ An", "Ninh Bình", "Ninh Thuận", "Phú Thọ", "Phú Yên", "Quảng Bình", "Quảng Nam", "Quảng Ngãi", "Quảng Ninh", "Quảng Trị",
            "Sóc Trăng", "Sơn La", "Tây Ninh", "Thái Bình", "Thái Nguyên", "Thanh Hóa", "Thừa Thiên Huế", "Tiền Giang", "Trà Vinh", "Tuyên Quang", "Vĩnh Long",
            "Vĩnh Phúc", "Yên Bái"];
        const citySelect = document.getElementById('city');
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city; // Giữ nguyên giá trị gốc
            option.textContent = city;
            citySelect.appendChild(option);
        });
    </script>
    <div class="container-fluid">
        <div class="row px-md-5">
            <!-- Cột đề thi -->
            <div class="col-12 col-md-9 pe-md-3">
                <!-- Tiêu đề chính -->
                <h1 class="title-button">Phổ biến nhất</h1>

                <!-- Danh mục lớp 10 -->
                <h3 class="text-primary">Lớp 10</h3>
                <div class="row">
                    <div class="col-12 col-md-6 mb-4" th:each="exam : ${grade10Exams}">
                        <div class="exam-card p-3 shadow-sm ">
                            <h4 th:text="${exam.examName}" class="text-primary d-block mb-2 text-center"></h4>
                            <p><i class="fa-solid fa-graduation-cap text-success"></i> <b>Lớp:</b> <span th:text="${exam.grade}"></span></p>
                            <p><i class="fa-solid fa-book text-info"></i> <b>Môn học:</b> <span th:text="${exam.subject}"></span></p>
                            <p><i class="fa-solid fa-file-lines text-warning"></i> <b>Dạng đề:</b> <span th:text="${exam.examType}"></span></p>
                            <p><i class="fa-solid fa-map-marker-alt text-danger"></i> <b>Tỉnh-Thành Phố:</b> <span th:text="${exam.city}"></span></p>
                            <p><i class="fa-solid fa-users text-primary"></i> <b>Số lượt tham gia:</b> <span th:text="${exam.participantCount}"></span></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <a th:href="@{/exams/{id}/detail(id=${exam.examID})}" class="btn-custom btn-view">
                                    <i class="fa-solid fa-eye"></i> Xem
                                </a>
                                <a th:href="@{/exams/{id}/do(id=${exam.examID})}" class="btn-custom btn-do">
                                    <i class="fa-solid fa-pen"></i> Làm bài
                                </a>
                                <button class="btn btn-outline-danger btn-sm likeButton" th:attr="data-exam-id=${exam.examID}, data-liked=${isLiked}">
                                    <i class="fa-regular fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danh mục lớp 11 -->
                <h3 class="text-primary ">Lớp 11</h3>
                <div class="row">
                    <div class="col-12 col-md-6 mb-4" th:each="exam : ${grade11Exams}">
                        <div class="exam-card p-3 shadow-sm ">
                            <h4 th:text="${exam.examName}" class="text-primary d-block mb-2 text-center"></h4>
                            <p><i class="fa-solid fa-graduation-cap text-success"></i> <b>Lớp:</b> <span th:text="${exam.grade}"></span></p>
                            <p><i class="fa-solid fa-book text-info"></i> <b>Môn học:</b> <span th:text="${exam.subject}"></span></p>
                            <p><i class="fa-solid fa-file-lines text-warning"></i> <b>Dạng đề:</b> <span th:text="${exam.examType}"></span></p>
                            <p><i class="fa-solid fa-map-marker-alt text-danger"></i> <b>Tỉnh-Thành Phố:</b> <span th:text="${exam.city}"></span></p>
                            <p><i class="fa-solid fa-users text-primary"></i> <b>Số lượt tham gia:</b> <span th:text="${exam.participantCount}"></span></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <a th:href="@{/exams/{id}/detail(id=${exam.examID})}" class="btn-custom btn-view">
                                    <i class="fa-solid fa-eye"></i> Xem
                                </a>
                                <a th:href="@{/exams/{id}/do(id=${exam.examID})}" class="btn-custom btn-do">
                                    <i class="fa-solid fa-pen"></i> Làm bài
                                </a>
                                <button class="btn btn-outline-danger btn-sm likeButton" th:attr="data-exam-id=${exam.examID}, data-liked=${isLiked}">
                                    <i class="fa-regular fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danh mục lớp 12 -->
                <h3 class="text-primary ">Lớp 12</h3>
                <div class="row">
                    <div class="col-12 col-md-6 mb-4" th:each="exam : ${grade12Exams}">
                        <div class="exam-card p-3 shadow-sm ">
                            <h4 th:text="${exam.examName}" class="text-primary d-block mb-2 text-center"></h4>
                            <p><i class="fa-solid fa-graduation-cap text-success"></i> <b>Lớp:</b> <span th:text="${exam.grade}"></span></p>
                            <p><i class="fa-solid fa-book text-info"></i> <b>Môn học:</b> <span th:text="${exam.subject}"></span></p>
                            <p><i class="fa-solid fa-file-lines text-warning"></i> <b>Dạng đề:</b> <span th:text="${exam.examType}"></span></p>
                            <p><i class="fa-solid fa-map-marker-alt text-danger"></i> <b>Tỉnh-Thành Phố:</b> <span th:text="${exam.city}"></span></p>
                            <p><i class="fa-solid fa-users text-primary"></i> <b>Số lượt tham gia:</b> <span th:text="${exam.participantCount}"></span></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <a th:href="@{/exams/{id}/detail(id=${exam.examID})}" class="btn-custom btn-view">
                                    <i class="fa-solid fa-eye"></i> Xem
                                </a>
                                <a th:href="@{/exams/{id}/do(id=${exam.examID})}" class="btn-custom btn-do">
                                    <i class="fa-solid fa-pen"></i> Làm bài
                                </a>
                                <button class="btn btn-outline-danger btn-sm likeButton" th:attr="data-exam-id=${exam.examID}, data-liked=${isLiked}">
                                    <i class="fa-regular fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Cột xếp hạng -->
            <div class="col-12 col-md-3 px-md-3">
                <div class="rank-section p-3 shadow-sm ">
                    <h4 class="text-center mb-3">BXH Điểm Số</h4>
                    <ul id="leaderboard" class="list-group">
                        <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                    </ul>

                    <h4 class="text-center mt-4 mb-3">BXH Đóng Góp</h4>
                    <ul id="contribution-board" class="list-group">
                        <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                    </ul>
                </div>
            </div>

        </div>
    </div>


</main>
<script>
    document.querySelectorAll(".likeButton").forEach(button => {
        let examId = button.getAttribute("data-exam-id");
        let icon = button.querySelector("i");

        // Kiểm tra trạng thái like khi trang tải
        fetch(`/exams/${examId}/isLiked`)
            .then(response => response.json())
            .then(data => {
                if (data.liked) {
                    button.classList.add("liked");
                    icon.classList.replace("fa-regular", "fa-solid");
                }
            })
            .catch(error => console.error("Lỗi kiểm tra like:", error));

        // Toggle Like/Unlike chỉ thay đổi giao diện, không lưu đề
        button.addEventListener("click", function () {
            // Chỉ cập nhật giao diện
            button.classList.toggle("liked");
            icon.classList.toggle("fa-solid");
            icon.classList.toggle("fa-regular");

            // Nếu bạn không muốn gửi yêu cầu lưu đề, hãy comment hoặc xóa đoạn fetch dưới đây

            fetch(`/exams/${examId}/like`, {
                method: button.classList.contains("liked") ? "POST" : "DELETE"
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Bạn cần đăng nhập để like.") {
                        if (confirm("Bạn cần đăng nhập để like. Chuyển đến trang đăng nhập?")) {
                            window.location.href = "/login";
                        }
                        return;
                    }
                    showToast(data.message);
                })
                .catch(error => console.error("Lỗi:", error));

        });
    });

    function showToast(message) {
        let toast = document.getElementById("toast");
        toast.innerText = message;
        toast.classList.add("show");

        // Ẩn thông báo sau 3 giây
        setTimeout(() => {
            toast.classList.remove("show");
        }, 3000);
    }
    async function updateLeaderboard() {
        try {
            let response = await fetch("/top-score");
            let data = await response.json();
            let leaderboard = document.querySelector("#leaderboard");
            leaderboard.innerHTML = "";

            data.forEach(record => {
                let formattedScore = record.totalScore.toFixed(0);
                let avatarUrl = record.avatarUrl || "https://via.placeholder.com/40"; // Avatar mặc định nếu không có

                let row = `<li class="list-group-item d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="${avatarUrl}" alt="Avatar" class="rounded-circle me-2" width="40" height="40" >
                    <span class="text-truncate" style="max-width: 70%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-left: 1px">
                        ${record.username}
                    </span>
                </div>
                <span>${formattedScore} Điểm</span>
            </li>`;

                leaderboard.innerHTML += row;
            });
        } catch (error) {
            console.error("Lỗi khi cập nhật BXH:", error);
        }
    }

    async function updateContributionBoard() {
        try {
            let response = await fetch("/top-contribute");
            let data = await response.json();
            let contributionBoard = document.querySelector("#contribution-board");
            contributionBoard.innerHTML = "";

            data.forEach(record => {
                let formattedScore = record.totalScore.toFixed(0);
                let avatarUrl = record.avatarUrl || "https://via.placeholder.com/40"; // Avatar mặc định nếu không có

                let row = `<li class="list-group-item d-flex align-items-center">
                <img src="${avatarUrl}" alt="Avatar" class="rounded-circle me-2" width="40" height="40">
                <span class="text-truncate flex-grow-1" style="max-width: 60%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                    ${record.username}
                </span>
                <span class="text-end fw-bold">${formattedScore} Điểm</span>
            </li>`;

                contributionBoard.innerHTML += row;
            });
        } catch (error) {
            console.error("Lỗi khi cập nhật BXH Đóng Góp:", error);
        }
    }

    // Cập nhật BXH khi trang load xong
    document.addEventListener("DOMContentLoaded", () => {
        updateLeaderboard();
        updateContributionBoard();

        // Tự động cập nhật BXH mỗi 5 giây
        // setInterval(updateLeaderboard, 5000);
        // setInterval(updateContributionBoard, 5000);
    });
</script>
<div th:insert="~{fragments/logoutModal :: logoutModal}"></div>
<div th:insert="~{fragments/footer :: footer}"></div>

</body>
</html>